---
- name: Install deps
  ansible.builtin.apt:
    lock_timeout: 240
    update_cache: true
    pkg:
      - apt-transport-https
      - ca-certificates
      - gnupg

- name: Download fdio gpg key
  ansible.builtin.command:
    cmd: bash -c "curl -fsSL https://packagecloud.io/fdio/release/gpgkey | gpg --dearmor > /etc/apt/keyrings/fdio_release-archive-keyring.gpg"
    creates: /etc/apt/keyrings/fdio_release-archive-keyring.gpg

- name: Setup fdio apt repo
  ansible.builtin.copy:
    src: 99fd.io.list
    dest: /etc/apt/sources.list.d/99fd.io.list
    mode: "644"
    owner: root
    group: root

- name: Install vpp
  ansible.builtin.apt:
    update_cache: true
    pkg:
      - vpp
      - vpp-plugin-core
      - vpp-plugin-dpdk

- name: Create log directory so service doesn't crash
  ansible.builtin.file:
    path: /var/log/vpp/
    state: directory
    mode: '0600'
    owner: vpp
    group: vpp

- name: Setup vppcfg
  ansible.builtin.include_tasks: vppcfg.yml
  when: ansible_vpp_setup_vppcfg is defined and ansible_vpp_setup_vppcfg

- name: VPP Config
  ansible.builtin.template:
    src: vpp.conf.j2
    dest: /etc/vpp.conf
    owner: root
    group: root
    mode: "640"
  when: ansible_vpp_deploy_config is defined and ansible_vpp_deploy_config

- name: Set sysctls
  ansible.builtin.copy:
    content: "{{ ansible_vpp_sysctls }}"
    dest: /etc/sysctl.d/80-vpp.conf
    owner: root
    group: root
    mode: '0644'
  when: ansible_vpp_sysctls is defined and ansible_vpp_sysctls != ""

- name: Apply sysctls
  ansible.builtin.command:
    cmd: sysctl --all
  when: ansible_vpp_sysctls is defined and ansible_vpp_sysctls != ""

- name: Add user {{ item }} to vpp group
  ansible.builtin.user:
    name: "{{ item }}"
    group: vpp
    append: true
  loop: "{{ ansible_vpp_add_user_to_vpp.split(',') }}"
  when: ansible_vpp_add_user_to_vpp is defined and ansible_vpp_add_user_to_vpp != ""
